from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes, CallbackQueryHandler
import requests
from config import BOT_TOKEN, CHANNEL_USERNAME

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    member = await context.bot.get_chat_member(CHANNEL_USERNAME, user.id)
    if member.status in ['left', 'kicked']:
        keyboard = [
            [InlineKeyboardButton("ğŸ“¢ Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú©Ø§Ù†Ø§Ù„", url=f"https://t.me/{CHANNEL_USERNAME.strip('@')}")],
            [InlineKeyboardButton("âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª", callback_data='check')]
        ]
        await update.message.reply_text("Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ Ø¹Ø¶Ùˆ Ø´ÙˆÛŒØ¯:", reply_markup=InlineKeyboardMarkup(keyboard))
    else:
        await update.message.reply_text("Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ! Ø§Ø² Ø¯Ø³ØªÙˆØ± /fal ÛŒØ§ /weather ÛŒØ§ /music Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†!")

async def check_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    await query.answer()
    member = await context.bot.get_chat_member(CHANNEL_USERNAME, user.id)
    if member.status in ['left', 'kicked']:
        await query.edit_message_text("Ù‡Ù†ÙˆØ² Ø¹Ø¶Ùˆ Ù†Ø´Ø¯ÛŒ. Ù„Ø·ÙØ§Ù‹ Ø¹Ø¶Ùˆ Ø´Ùˆ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†.")
    else:
        await query.edit_message_text("âœ… Ø¹Ø¶ÙˆÛŒØª ØªØ£ÛŒÛŒØ¯ Ø´Ø¯! Ø­Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§Ø² Ø±Ø¨Ø§Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒ.")

async def fal(update: Update, context: ContextTypes.DEFAULT_TYPE):
    falls = [
        "âœ¨ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø®Ø¨Ø± Ø®ÙˆØ¨ÛŒ Ù…ÛŒâ€ŒØ´Ù†ÙˆÛŒ!",
        "ğŸŒŸ ÙˆÙ‚ØªØ´Ù‡ Ø¨Ø±Ø§ÛŒ ÛŒÙ‡ ØªØºÛŒÛŒØ± Ø¨Ø²Ø±Ú¯.",
        "ğŸŒˆ Ù†ÛŒØªØª Ù¾Ø§Ú©Ù‡ØŒ Ø¨Ù‡Ø´ Ù…ÛŒâ€ŒØ±Ø³ÛŒ.",
        "ğŸ”¥ Ø§ÛŒÙ† Ù‡ÙØªÙ‡ Ø¨Ø±Ø§Øª Ù¾Ø± Ø§Ø² Ø§Ù†Ø±Ú˜ÛŒ Ø®ÙˆØ¨Ù‡."
    ]
    from random import choice
    await update.message.reply_text(choice(falls))

async def jok(update: Update, context: ContextTypes.DEFAULT_TYPE):
    jokes = [
        "ğŸ˜‚ Ú†Ø±Ø§ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ†ÙˆÛŒØ³Ø§ Ù†Ù…ÛŒâ€ŒØ±Ù† Ø¨Ù‡ Ø¢Ø³Ù…ÙˆÙ†ØŸ Ú†ÙˆÙ† Ø¨Ø§Ú¯ Ø¯Ø§Ø±Ù‡!",
        "ğŸ˜… ÛŒÚ©ÛŒ Ú¯ÙØª Ù…Ù† Ø¢Ú†Ø§Ø± ÙØ±Ø§Ù†Ø³Ù‡â€ŒØ§Ù…ØŒ Ú¯ÙØªÙ… ØªÙˆ Ú©Ù‡ Ù¾ÛŒÚ†ÛŒØ¯ÛŒ Ø±ÙØªÛŒ!",
        "ğŸ¤£ Ø¨Ø§Ø¨Ø§Ù… Ú¯ÙØª Ù…ÙˆÙ‡Ø§Øª Ø±Ùˆ Ø¨Ø²Ù†ØŒ Ú¯ÙØªÙ… ØªÙˆ Ø¨Ø²Ù†! Ú¯ÙØª Ø¨Ú†Ù‡â€ŒØ±Ùˆ Ø¨Ø¨ÛŒÙ† Ú†Ù‡ Ù¾Ø±Ø±Ùˆ Ø´Ø¯Ù‡!"
    ]
    from random import choice
    await update.message.reply_text(choice(jokes))

async def weather(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if context.args:
        city = ' '.join(context.args)
        url = f"https://wttr.in/{city}?format=3"
        try:
            response = requests.get(url)
            if response.status_code == 200:
                await update.message.reply_text(f"ğŸŒ¤ ÙˆØ¶Ø¹ÛŒØª Ù‡ÙˆØ§: {response.text}")
            else:
                await update.message.reply_text("âŒ Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.")
        except:
            await update.message.reply_text("âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¢Ø¨â€ŒÙˆÙ‡ÙˆØ§.")
    else:
        await update.message.reply_text("ğŸ“ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø´Ù‡Ø± Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù†. Ù…Ø«Ù„Ø§:\n/weather Tehran")

async def music(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if context.args:
        query = ' '.join(context.args)
        youtube_search_url = f"https://www.youtube.com/results?search_query={query.replace(' ', '+')}"
        await update.message.reply_text(f"ğŸ¶ Ù†ØªÛŒØ¬Ù‡ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ: {query}\nğŸ”— {youtube_search_url}")
    else:
        await update.message.reply_text("ğŸ“Œ Ù„Ø·ÙØ§Ù‹ Ø§Ø³Ù… Ø¢Ù‡Ù†Ú¯ Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³. Ù…Ø«Ù„Ø§Ù‹:\n/music Gole Yakh Ebi")

if __name__ == '__main__':
    app = ApplicationBuilder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(check_callback, pattern='check'))
    app.add_handler(CommandHandler("fal", fal))
    app.add_handler(CommandHandler("jok", jok))
    app.add_handler(CommandHandler("weather", weather))
    app.add_handler(CommandHandler("music", music))
    app.run_polling()
